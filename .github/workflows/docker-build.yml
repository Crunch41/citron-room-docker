name: Build on Citron Room Changes

on:
  # Allow manual trigger
  workflow_dispatch:
  # Build on Dockerfile changes (for our patches)
  push:
    branches: [ main, master ]
    paths:
      - 'Dockerfile'
      - 'docker-entrypoint.sh'

jobs:
  check-and-build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Allow pushing .last_citron_commit
      packages: write

    steps:
      - name: Checkout this repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Get latest Citron commit
        id: citron
        run: |
          # Get latest commit hash from Citron upstream
          COMMIT=$(git ls-remote https://git.citron-emu.org/Citron/Emulator.git HEAD | awk '{print $1}')
          SHORT_COMMIT=$(echo $COMMIT | cut -c1-7)
          
          echo "Latest Citron commit: $SHORT_COMMIT"
          echo "commit=$COMMIT" >> $GITHUB_OUTPUT
          echo "short_commit=$SHORT_COMMIT" >> $GITHUB_OUTPUT

      - name: Check last built commit
        id: last_build
        run: |
          # Check if we have a last built commit file
          if [ -f ".last_citron_commit" ]; then
            LAST_COMMIT=$(cat .last_citron_commit)
            echo "Last built commit: $LAST_COMMIT"
            echo "last_commit=$LAST_COMMIT" >> $GITHUB_OUTPUT
          else
            echo "No previous build found"
            echo "last_commit=" >> $GITHUB_OUTPUT
          fi

      - name: Clone Citron to check changes
        if: steps.last_build.outputs.last_commit != ''
        run: |
          git clone --depth 100 https://git.citron-emu.org/Citron/Emulator.git citron-upstream
          cd citron-upstream

      - name: Check if citron-room files changed
        if: steps.last_build.outputs.last_commit != ''
        id: check_changes
        run: |
          cd citron-upstream
          
          LAST_COMMIT="${{ steps.last_build.outputs.last_commit }}"
          NEW_COMMIT="${{ steps.citron.outputs.commit }}"
          
          # Check if any citron-room related files changed
          CHANGED_FILES=$(git diff --name-only $LAST_COMMIT $NEW_COMMIT 2>/dev/null || echo "force_build")
          
          if [ "$CHANGED_FILES" = "force_build" ]; then
            echo "Could not compare commits - will build"
            echo "should_build=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check if any of our patched files changed
          RELEVANT_CHANGES=$(echo "$CHANGED_FILES" | grep -E '^src/(dedicated_room|web_service|network)/' || true)
          
          if [ -n "$RELEVANT_CHANGES" ]; then
            echo "Citron-room related files changed:"
            echo "$RELEVANT_CHANGES"
            echo "should_build=true" >> $GITHUB_OUTPUT
          else
            echo "No citron-room files changed since last build"
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi

      - name: Force build if first run or manual
        id: final_check
        run: |
          # Force build if no last commit (first run) or manual trigger
          if [ -z "${{ steps.last_build.outputs.last_commit }}" ] || [ "${{ github.event_name }}" = "workflow_dispatch" ] || [ "${{ github.event_name }}" = "push" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
          else
            echo "should_build=${{ steps.check_changes.outputs.should_build }}" >> $GITHUB_OUTPUT
          fi

      - name: Skip if no changes
        if: steps.final_check.outputs.should_build == 'false'
        run: |
          echo "No citron-room changes detected. Exiting."
          exit 0

      - name: Set up Docker Buildx
        if: steps.final_check.outputs.should_build == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        if: steps.final_check.outputs.should_build == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        if: steps.final_check.outputs.should_build == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/citron-room-server:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/citron-room-server:${{ steps.citron.outputs.short_commit }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Update last built commit
        if: steps.final_check.outputs.should_build == 'true'
        run: |
          echo "${{ steps.citron.outputs.commit }}" > .last_citron_commit
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .last_citron_commit
          git diff --staged --quiet || git commit -m "Built from Citron commit ${{ steps.citron.outputs.short_commit }}"
          git push

      - name: Notify Discord (optional)
        if: steps.final_check.outputs.should_build == 'true'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            COMMIT="${{ steps.citron.outputs.short_commit }}"
            MESSAGE="âœ… New Citron Room Server built from commit ${COMMIT} (citron-room files changed)"
            
            curl -X POST "$DISCORD_WEBHOOK_URL" \
              -H "Content-Type: application/json" \
              -d "{\"content\": \"${MESSAGE}\"}" || true
          else
            echo "Discord webhook not configured, skipping notification"
          fi
